import { GoogleGenAI, HarmCategory, HarmBlockThreshold } from "@google/genai";

const FALLBACK_TEMPLATES = [
    "В вашем возрасте (${age} лет) многие ${zodiac} начинают чувствовать, что время ускользает. Вы окружаете себя делами, чтобы не слышать пустоту внутри, но ваше сердце требует иного. Текущий цикл ${zodiac} близок к завершению, и старые опоры начинают рушиться. Вы боитесь признаться себе, что проект или человек, в которого вы вложили столько сил, больше не приносит радости.---Сегодня вы получите звонок или сообщение, которое вернет вас к нерешенному вопросу полугодичной давности. Не закрывайтесь. Ваше спасение в том, от чего вы бежали.",
    "Вы долго играли роль 'сильного человека', но ${zodiac} в возрасте ${age} лет часто сталкиваются с выгоранием, которое невозможно скрыть за улыбкой. Вы чувствуете, что застряли в дне сурка, где каждый шаг предопределен обязательствами. Ваша интуиция кричит о подмене понятий: то, что вы называете стабильностью, на самом деле является клеткой.---Сегодняшний вечер станет моментом истины. Ожидайте случайного столкновения, которое подсветит вашу главную ошибку последнего месяца. Вы поймете, что ключ к свободе всегда был в вашем кармане, нужно лишь...",
    "Звезды говорят, что ваша главная проблема сейчас — это токсичная лояльность. Вы, как истинный ${zodiac}, тянете на себе груз чужих ожиданий, забывая о своих амбициях, которые в ${age} лет должны быть на пике. Вы боитесь обидеть тех, кто давно перестал ценить вашу поддержку. Этот застой в энергии блокирует ваш финансовый поток.---Смена декораций произойдет внезапно. Обратите внимание на цифры и знаки в первой половине дня. Вселенная дает вам последний шанс выйти из игры без потерь, если вы готовы на...",
    "Для ${zodiac} в возрасте ${age} сейчас наступает период 'великого сомнения'. Вы достигли многого, но ночью, когда гаснет свет, вы спрашиваете себя: 'И это всё?'. Вы чувствуете фальшь в словах близкого человека, но предпочитаете верить в удобную ложь. Ваша энергия утекает через дыру в личных границах, которые вы позволили нарушить.---Сегодняшнее откровение придет через сон или случайную фразу прохожего. Вам укажут на то, что вы старательно игнорировали последние три недели. Будьте готовы к резкому разговору, который...",
    "Ваш астральный код ${zodiac} сейчас резонирует с темой 'незавершенного прошлого'. В ${age} лет старые обиды могут трансформироваться в физическую усталость. Вы пытаетесь строить будущее на фундаменте, который уже треснул. Звезды видят, что вы скрываете свою истинную страсть от окружающих, боясь осуждения. Но именно там скрыт ваш истинный успех.---Судьба приготовила вам сюрприз в финансовой сфере. Внезапное предложение или инсайд помогут закрыть старый долг, но цена за это — ваша честность перед собой. Вечером вы осознаете, что..."
];

let ai: GoogleGenAI | null = null;

const initAI = () => {
    if (process.env.API_KEY && !ai) {
        try {
            ai = new GoogleGenAI({ apiKey: process.env.API_KEY });
        } catch (e) {
            console.warn("Gemini Client Init Failed:", e);
        }
    }
    return ai;
};

export const generateDailyHoroscope = async (
    zodiac: string,
    name: string,
    birthDate: string
): Promise<string> => {
    const client = initAI();
    const age = new Date().getFullYear() - new Date(birthDate).getFullYear();
    const randomFallback = FALLBACK_TEMPLATES[Math.floor(Math.random() * FALLBACK_TEMPLATES.length)]
        .replace('${age}', age.toString())
        .replace(/\${zodiac}/g, zodiac);

    if (!client) return randomFallback;

    try {
        const randomSeed = Math.floor(Math.random() * 1000000);
        
        const response = await client.models.generateContent({
            model: 'gemini-3-flash-preview',
            contents: `Пользователь: ${name}, Знак: ${zodiac}, Возраст: ${age} лет. Дата: ${new Date().toLocaleDateString()}. Хаос-код: ${randomSeed}.`,
            config: {
                systemInstruction: `Ты — Оракул Этерии. Твоя цель — заставить пользователя (Знак: ${zodiac}, Возраст: ${age}) почувствовать, что ты читаешь его мысли.
                
                ВАЖНО: Каждый ответ должен быть уникальным. Используй Хаос-код ${randomSeed} для выбора новой темы (деньги, секс, предательство, успех, одиночество).
                
                СТРУКТУРА (РАЗДЕЛИТЕЛЬ '---'):
                Часть 1 (ИНТРИГА, 5-6 СТРОК): Глубокий психологический портрет. Бей в боли возраста ${age} лет. Если 30+ — говори о кризисе смыслов и потере ориентиров. Если 20+ — о страхе выбора и фальшивых авторитетах. 
                Часть 2 (ТАЙНА): Конкретика на сегодня. Что-то шокирующее или очень точное.
                
                СТИЛЬ: Высокий мистицизм, никакой 'воды'. Заканчивай интригу на полуслове.`,
                temperature: 1.0,
                seed: randomSeed,
                safetySettings: [
                    { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },
                ]
            }
        });
        
        const text = response.text;
        return text && text.includes('---') ? text : randomFallback;
    } catch (error) {
        console.error("Horoscope API Error:", error);
        return randomFallback;
    }
};

export const askTheOracle = async (userQuestion: string, zodiac: string, name: string): Promise<string> => {
    return "Оракул сосредоточен на главном пророчестве.";
};